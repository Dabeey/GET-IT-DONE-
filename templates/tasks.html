{% extends 'base.html' %}

{% block title %}Tasks - Get It Done!{% endblock %}

{% block content %}
<div class="container mt-5">
    <h1 class="text-center mb-4">Manage Your Tasks</h1>

    <!-- Filter Bar -->
    <div class="filter-bar mb-4 d-flex justify-content-center">
        <a href="{{ url_for('tasks', filter='all') }}" class="btn btn-outline-primary me-2 {% if filter_type == 'all' %}active{% endif %}">All</a>
        <a href="{{ url_for('tasks', filter='today') }}" class="btn btn-outline-primary me-2 {% if filter_type == 'today' %}active{% endif %}">Today</a>
        <a href="{{ url_for('tasks', filter='week') }}" class="btn btn-outline-primary me-2 {% if filter_type == 'week' %}active{% endif %}">This Week</a>
        <a href="{{ url_for('tasks', filter='month') }}" class="btn btn-outline-primary me-2 {% if filter_type == 'month' %}active{% endif %}">This Month</a>
        <a href="{{ url_for('tasks', filter='pending') }}" class="btn btn-outline-warning me-2 {% if filter_type == 'pending' %}active{% endif %}">Pending</a>
        <a href="{{ url_for('tasks', filter='ongoing') }}" class="btn btn-outline-info me-2 {% if filter_type == 'ongoing' %}active{% endif %}">Ongoing</a>
        <a href="{{ url_for('tasks', filter='completed') }}" class="btn btn-outline-success me-2 {% if filter_type == 'completed' %}active{% endif %}">Completed</a>
        <a href="{{ url_for('tasks', filter='overdue') }}" class="btn btn-outline-danger {% if filter_type == 'overdue' %}active{% endif %}">Overdue</a>
    </div>

    <!-- Progress Indicators -->
    <div class="progress-indicators d-flex justify-content-around mb-4">
        <div class="text-center">
            <div class="progress-circle pending">
                <span>{{ pending_count }}</span>
            </div>
            <p class="mt-2">Pending</p>
        </div>
        <div class="text-center">
            <div class="progress-circle ongoing">
                <span>{{ ongoing_count }}</span>
            </div>
            <p class="mt-2">Ongoing</p>
        </div>
        <div class="text-center">
            <div class="progress-circle completed">
                <span>{{ completed_count }}</span>
            </div>
            <p class="mt-2">Completed</p>
        </div>
    </div>

    <!-- Tasks Section -->
    {% if tasks|length > 0 %}
    <div class="task-list">
        <ul id="task-list" class="list-group">
            {% for task in tasks %}
            <li class="list-group-item task-item rounded mb-3" data-task-id="{{ task.id }}">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <input type="checkbox" {% if task.status.value == 'Done' %}checked{% endif %} onclick="markTaskComplete({{ task.id }})">
                        <strong class="{% if task.is_overdue %}text-danger{% endif %}">{{ task.title }}</strong>
                        <small class="text-muted">Due: {{ task.due_date }}</small>
                        {% if task.is_overdue %}
                        <i class="bi bi-exclamation-triangle-fill text-danger ms-2" title="Overdue"></i>
                        {% endif %}
                        <span class="badge bg-secondary">{{ task.project.name }}</span>
                    </div>
                    <div>
                        <a href="{{ url_for('edit_task', task_id=task.id) }}" class="btn btn-sm btn-outline-primary">Edit</a>
                        <form method="POST" action="{{ url_for('delete_task', task_id=task.id) }}" class="d-inline">
                            {{ form.hidden_tag() }}
                            <button type="submit" class="btn btn-sm btn-outline-danger">Delete</button>
                        </form>
                    </div>
                </div>
            </li>
            {% endfor %}
        </ul>
    </div>
    {% else %}
    <div class="alert alert-info text-center" role="alert">
        No tasks found for this filter.
    </div>
    {% endif %}
</div>

<script>
    // Drag and Drop Functionality
    const taskList = document.getElementById('task-list');
    let draggedItem = null;

    taskList.addEventListener('dragstart', (e) => {
        draggedItem = e.target;
        e.target.style.opacity = 0.5;
    });

    taskList.addEventListener('dragend', (e) => {
        e.target.style.opacity = '';
    });

    taskList.addEventListener('dragover', (e) => {
        e.preventDefault();
    });

    taskList.addEventListener('drop', (e) => {
        e.preventDefault();
        if (e.target.classList.contains('task-item')) {
            taskList.insertBefore(draggedItem, e.target.nextSibling);
        }
    });

    // Mark Task as Complete
    function markTaskComplete(taskId) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/complete_task/${taskId}`;
        document.body.appendChild(form);
        form.submit();
    }
</script>

<style>
    .progress-circle {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 1.5rem;
        font-weight: bold;
        color: #fff;
    }

    .progress-circle.pending {
        background-color: #ffc107;
    }

    .progress-circle.ongoing {
        background-color: #17a2b8;
    }

    .progress-circle.completed {
        background-color: #28a745;
    }

    .task-item {
        cursor: grab;
    }

    .task-item:active {
        cursor: grabbing;
    }
</style>
{% endblock %}